<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Chat</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="css/main.css" />
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12 col-md-2">
	
			</div>

			<div class="col-xs-12 col-md-8">
				<div id="chat_board" class="col-xs-12">
					<div class="col-xs-8 text-center">
						<h4>Bem vindo (a)!</h4>
					</div>

					<div class="col-xs-4 user-number">

					</div>

					<div class="col-xs-12">
						<ul class="nav nav-tabs my-chats">

						</ul>
						<div class="tab-content mp">
						    <div id="home" class="tab-pane fade in active">
						    	
							</div>
						</div>
					</div>

					<div class="col-xs-8 chat-content">
						
					</div>
					
					<div class="col-xs-4 chat-users">
						<div class="chat-menu">
							<p>Enviar MP</p>
							<p>Iniciar video chamada</p>
						</div>
					</div>
				</div>

				<div class="col-xs-8 container-txt-send">
					<input type="text" class="form-control txt-send">
				</div>
				<div class="col-xs-4 container-btn-send">
					<button type="button" class="btn btn-primary btn-send">Enviar</button>
				</div>
			</div>	

			<div class="col-xs-12 col-md-2">
	
			</div>			
		</div>
	</div>
	
	<div id="myModal" class="modal fade" role="dialog">
	  	<div class="modal-dialog">
		    <!-- Modal content-->
		    <div class="modal-content">
			    <div class="modal-header">
				    <button type="button" class="close" data-dismiss="modal">&times;</button>
			        <h4 class="modal-title">VideoCall</h4>
			    </div>
			    <div class="modal-body">
			        <video id="localVideo" autoplay muted></video>
				    <video id="remoteVideo" autoplay></video>

				    <div>
				 	   <button id="startButton">Start</button>
				    	<button id="callButton">Call</button>
				    	<button id="hangupButton">Hang Up</button>
				    </div>
			    </div>
			    <div class="modal-footer">
			        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			    </div>
			 </div>

		</div>
	</div>
			
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="js/common.js"></script>
  <script src="js/lib/ga.js"></script>
  <script src="js/main.js"></script>
<script>
	$(document).ready(function(){
		var nick = "";
		/**definir nick do utilizador*/
		do{
			nick = prompt("Insira o seu nick:");
		} while(nick == null || nick.length == 0);

		/**conectar-se ao servidor*/
		var conn = new WebSocket('ws://localhost:8080/web'); //link to page where shows data
		/**Sempre que receber uma mensage*/
		conn.onmessage = function(e) { 
			var code = e.data[0];
			var content = e.data.slice(1, e.data.length);

			switch (code) {
				case "1": /**add user to ist*/
					$(".chat-users").html($(".chat-users").html() + "<div class='nick col-xs-12 text-center " + content + "'>" + content + "</div>");
					conn.send(3 + $(".chat-users").html());
					nick_callback(nick);
					setUserNumber();
				break;

				case "2": /**add message*/
					var msg = "<div class='char-item text-left col-xs-12'>" + content + "</div>";
					$(".chat-content").html($(".chat-content").html() + msg);
				break;

				case "3":
					$(".chat-users").html(content);
					nick_callback(nick);
					setUserNumber();
				break;

				case "4":
					$(".chat-users").html(content);
					nick_callback(nick);
					setUserNumber();
				break;

				case "5":
					if(confirm("Aceitar video chamada de " + content)) {
						showModal();
					} else{
						conn.send("6");
					}
				break;

				case "6": /**Video chamada cancelada*/
					alert("A chamada rejeitada!");
				break;

				default:
				break;

			} 
		};

		/**Ao ligar-se*/
		conn.onopen = function(e) {
			var msg = "1" + nick;
			conn.send(msg);
			$(".chat-users").html("<div class='nick col-xs-12 text-center " + nick+ "'>" + nick + "</div>");
			//evt($(".nick")[$(".nick").length - 1].id, "dblclick", nick_callback(nick));				
			
			nick_callback(nick);

		}

		$('.txt-send').keyup(function(e){
		    if(e.keyCode == 13){
		        $(".btn-send").trigger('click');
		    }
		});		
				

		/**Enviar mensagem*/
		$(".btn-send").click(function(e){
			e.preventDefault();
			var d = new Date();
			var data = d.getHours()+ ":" + d.getMinutes() + ":" + d.getSeconds();
			if($(".txt-send").val().length > 0){
				var d = new Date();
				var data = d.getHours()+ ":" + d.getMinutes() + ":" + d.getSeconds();
				var message = "2" + nick + " Ã¡s " + data + " - " + $(".txt-send").val();					
				conn.send(message);
				$(".txt-send").val("");
				$(".chat-content").html($(".chat-content").html() + "<div class='col-xs-12 char-item'>"  + message.slice(1,message.length) + "</div>");
			}
		});

		$(window).on('unload',function() {
			$("."+nick).remove();
		  	conn.send("4" + $(".chat-users").html());
		})

		function nick_callback(n){
			$.each($(".nick"),function(){
				$(this).click(function(){
					
					if($(this).html().localeCompare(nick) == 0) {
						console.log("Clicaste em ti mesmo");
					} else {
						showModal($(this).html());
						conn.send("5"+$(this).html());
					}
				});
			});
		}

		function evt(selector, event, callback){
			$(selector).on(event,callback);
		}

		function setUserNumber(){
			$(".user-number").html("Users Online:" + $(".nick").length -1);
		}

		function showModal(title){
			title != "undefined" ? $(".modal-title").html("VideoCall With " + title): $(".modal-title").html("VideoCall");
			$("#myModal").modal("show");
		}
	});	

</script>
</body>
</html>